// ----- motor.c ìƒë‹¨, ë³€ìˆ˜ ì •ì˜ ë’¤ -----

// í•„í„°ë§ëœ ìµœì¢… ADC ê°’
volatile uint32_t adc_scaled[4] = {0,0,0,0};

// UART ë²„í¼
uint8_t rxData = 0;
uint8_t rxBuf[RX_BUF_SIZE];
volatile uint8_t rxIndex = 0;

// --- ë“¤ì–´ì˜¨ í•œ ì¤„ ë¬¸ìì—´ ì²˜ë¦¬ ---
void ProcessReceivedLine(uint8_t *line)
{
    // ë¬¸ìì—´ ë””ë²„ê¹… ì¶œë ¥
    char dbg[80];
    sprintf(dbg, "RAW:'%s'\r\n", (char*)line);
    HAL_UART_Transmit(&huart2, (uint8_t*)dbg, strlen(dbg), 100);

    // "ADC:"ë¡œ ì‹œì‘í•˜ë©´ íŒŒì‹±
    if (strncmp((char*)line, "ADC:", 4) == 0) {
        uint32_t tmp[4] = {0};

        int parsed = sscanf((char*)line, "ADC:%lu,%lu,%lu,%lu",
                            &tmp[0], &tmp[1], &tmp[2], &tmp[3]);

        if (parsed == 4) {
            adc_scaled[0] = tmp[0];
            adc_scaled[1] = tmp[1];
            adc_scaled[2] = tmp[2];
            adc_scaled[3] = tmp[3];
        }

        sprintf(dbg, "PARSED=%d [%lu,%lu,%lu,%lu]\r\n",
                parsed, adc_scaled[0], adc_scaled[1], adc_scaled[2], adc_scaled[3]);
        HAL_UART_Transmit(&huart2, (uint8_t*)dbg, strlen(dbg), 100);
    }
}

// --- UART ìˆ˜ì‹  ì¸í„°ëŸ½íŠ¸ ì½œë°± ìˆ˜ì • ---
void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)
{
    if (huart->Instance == USART1)
    {
        if(rxIndex < RX_BUF_SIZE - 1) {
            rxBuf[rxIndex++] = rxData;
        } else {
            rxIndex = 0; // overflow ì‹œ ì´ˆê¸°í™”
        }

        // ì¤„ë°”ê¿ˆ ë¬¸ì í™•ì¸
        if(rxData == '\n' || rxData == '\r') {
            if(rxIndex > 0) rxBuf[rxIndex-1] = '\0';
            else rxBuf[0] = '\0';

            if(strlen((char*)rxBuf) > 0)
                ProcessReceivedLine(rxBuf);

            rxIndex = 0;
        }

        // ë‹¤ìŒ ë¬¸ì ìˆ˜ì‹  ì¤€ë¹„
        HAL_UART_Receive_IT(&huart1, &rxData, 1);
    }
}

// ----- Motor_Init()ì—ì„œ UART ì¸í„°ëŸ½íŠ¸ ì‹œì‘ -----
void Motor_Init(void)
{
    HAL_TIM_PWM_Start(&htim3, TIM_CHANNEL_2);
    HAL_TIM_PWM_Start(&htim4, TIM_CHANNEL_2);

    currentCcrLeft = 0;
    currentCcrRight = 0;
    targetCcrLeft = 0;
    targetCcrRight = 0;
    SetMotorDirection_Safe();
    currentMode = GetCurrentMode();

    // ğŸ”¹ ì—¬ê¸°ì„œ UART ìˆ˜ì‹  ì¸í„°ëŸ½íŠ¸ ì‹œì‘
    HAL_UART_Receive_IT(&huart1, &rxData, 1);

    char msg[40];
    sprintf(msg, "[INIT] Mode: %s\r\n", (currentMode == MODE_AUTO) ? "AUTO" : "MANUAL");
    HAL_UART_Transmit(&huart2, (uint8_t*)msg, strlen(msg), 100);
}
